<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de localStorage en Tiempo Real</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .status-card.found {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .status-card.missing {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .log-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-entry.change {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        .log-entry.add {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }
        .log-entry.remove {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .timestamp {
            color: #666;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Monitor de localStorage en Tiempo Real</h1>
            <p>Esta herramienta monitorea continuamente los cambios en las claves de empresa y per√≠odo seleccionados.</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="startMonitoring()">‚ñ∂Ô∏è Iniciar Monitoreo</button>
            <button class="btn" onclick="stopMonitoring()">‚èπÔ∏è Detener Monitoreo</button>
            <button class="btn" onclick="clearLog()">üßπ Limpiar Log</button>
            <button class="btn danger" onclick="testRemoval()">üß™ Simular Eliminaci√≥n</button>
        </div>

        <div class="status-grid">
            <div class="status-card" id="company-status">
                <h3>üè¢ Estado de Empresa</h3>
                <div id="company-info">Verificando...</div>
            </div>
            <div class="status-card" id="period-status">
                <h3>üìÖ Estado de Per√≠odo</h3>
                <div id="period-info">Verificando...</div>
            </div>
        </div>

        <div>
            <h3>üìã Log de Cambios en Tiempo Real</h3>
            <div class="log-container" id="log-container"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            SELECTED_COMPANY: 'financial_app_selected_company',
            SELECTED_PERIOD: 'financial_app_selected_period'
        };

        let monitoringInterval = null;
        let previousValues = {};
        let logCount = 0;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            logCount++;
            if (logCount > 1000) {
                // Mantener solo los √∫ltimos 1000 logs
                const entries = logContainer.querySelectorAll('.log-entry');
                for (let i = 0; i < 100; i++) {
                    if (entries[i]) entries[i].remove();
                }
                logCount = 900;
            }
        }

        function updateStatus() {
            const companyData = localStorage.getItem(STORAGE_KEYS.SELECTED_COMPANY);
            const periodData = localStorage.getItem(STORAGE_KEYS.SELECTED_PERIOD);
            
            // Actualizar estado de empresa
            const companyCard = document.getElementById('company-status');
            const companyInfo = document.getElementById('company-info');
            
            if (companyData) {
                companyCard.className = 'status-card found';
                try {
                    const company = JSON.parse(companyData);
                    companyInfo.innerHTML = `
                        <strong>‚úÖ ENCONTRADA</strong><br>
                        <strong>Nombre:</strong> ${company.name}<br>
                        <strong>ID:</strong> ${company.id}<br>
                        <strong>Tama√±o:</strong> ${companyData.length} caracteres
                    `;
                } catch (e) {
                    companyInfo.innerHTML = `<strong>‚ö†Ô∏è ENCONTRADA (Error de formato)</strong><br>Datos corruptos`;
                }
            } else {
                companyCard.className = 'status-card missing';
                companyInfo.innerHTML = `<strong>‚ùå NO ENCONTRADA</strong><br>La clave no existe en localStorage`;
            }
            
            // Actualizar estado de per√≠odo
            const periodCard = document.getElementById('period-status');
            const periodInfo = document.getElementById('period-info');
            
            if (periodData) {
                periodCard.className = 'status-card found';
                try {
                    const period = JSON.parse(periodData);
                    periodInfo.innerHTML = `
                        <strong>‚úÖ ENCONTRADO</strong><br>
                        <strong>Nombre:</strong> ${period.period_name || 'Sin nombre'}<br>
                        <strong>ID:</strong> ${period.id}<br>
                        <strong>Fechas:</strong> ${period.start_date} - ${period.end_date}<br>
                        <strong>Tama√±o:</strong> ${periodData.length} caracteres
                    `;
                } catch (e) {
                    periodInfo.innerHTML = `<strong>‚ö†Ô∏è ENCONTRADO (Error de formato)</strong><br>Datos corruptos`;
                }
            } else {
                periodCard.className = 'status-card missing';
                periodInfo.innerHTML = `<strong>‚ùå NO ENCONTRADO</strong><br>La clave no existe en localStorage`;
            }
        }

        function checkForChanges() {
            const currentValues = {
                company: localStorage.getItem(STORAGE_KEYS.SELECTED_COMPANY),
                period: localStorage.getItem(STORAGE_KEYS.SELECTED_PERIOD)
            };
            
            // Verificar cambios en empresa
            if (previousValues.company !== currentValues.company) {
                if (previousValues.company === undefined) {
                    // Primera verificaci√≥n
                    if (currentValues.company) {
                        log(`üè¢ Empresa inicial detectada: ${JSON.parse(currentValues.company).name}`, 'add');
                    } else {
                        log(`üè¢ No hay empresa seleccionada inicialmente`, 'info');
                    }
                } else if (currentValues.company && !previousValues.company) {
                    // Se agreg√≥ empresa
                    const company = JSON.parse(currentValues.company);
                    log(`üè¢ ‚ûï EMPRESA AGREGADA: ${company.name} (ID: ${company.id})`, 'add');
                } else if (!currentValues.company && previousValues.company) {
                    // Se elimin√≥ empresa
                    const prevCompany = JSON.parse(previousValues.company);
                    log(`üè¢ ‚ùå EMPRESA ELIMINADA: ${prevCompany.name} (ID: ${prevCompany.id})`, 'remove');
                } else if (currentValues.company && previousValues.company) {
                    // Se cambi√≥ empresa
                    const newCompany = JSON.parse(currentValues.company);
                    const prevCompany = JSON.parse(previousValues.company);
                    log(`üè¢ üîÑ EMPRESA CAMBIADA: ${prevCompany.name} ‚Üí ${newCompany.name}`, 'change');
                }
                previousValues.company = currentValues.company;
            }
            
            // Verificar cambios en per√≠odo
            if (previousValues.period !== currentValues.period) {
                if (previousValues.period === undefined) {
                    // Primera verificaci√≥n
                    if (currentValues.period) {
                        const period = JSON.parse(currentValues.period);
                        log(`üìÖ Per√≠odo inicial detectado: ${period.period_name}`, 'add');
                    } else {
                        log(`üìÖ No hay per√≠odo seleccionado inicialmente`, 'info');
                    }
                } else if (currentValues.period && !previousValues.period) {
                    // Se agreg√≥ per√≠odo
                    const period = JSON.parse(currentValues.period);
                    log(`üìÖ ‚ûï PER√çODO AGREGADO: ${period.period_name} (${period.start_date} - ${period.end_date})`, 'add');
                } else if (!currentValues.period && previousValues.period) {
                    // Se elimin√≥ per√≠odo
                    const prevPeriod = JSON.parse(previousValues.period);
                    log(`üìÖ ‚ùå PER√çODO ELIMINADO: ${prevPeriod.period_name} (${prevPeriod.start_date} - ${prevPeriod.end_date})`, 'remove');
                } else if (currentValues.period && previousValues.period) {
                    // Se cambi√≥ per√≠odo
                    const newPeriod = JSON.parse(currentValues.period);
                    const prevPeriod = JSON.parse(previousValues.period);
                    log(`üìÖ üîÑ PER√çODO CAMBIADO: ${prevPeriod.period_name} ‚Üí ${newPeriod.period_name}`, 'change');
                }
                previousValues.period = currentValues.period;
            }
            
            updateStatus();
        }

        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            log('üöÄ Iniciando monitoreo en tiempo real...', 'info');
            
            // Verificaci√≥n inicial
            checkForChanges();
            
            // Monitoreo cada 100ms
            monitoringInterval = setInterval(checkForChanges, 100);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('‚èπÔ∏è Monitoreo detenido', 'info');
            }
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
            logCount = 0;
        }

        function testRemoval() {
            if (confirm('¬øQuieres simular la eliminaci√≥n de las claves para probar el monitoreo?')) {
                localStorage.removeItem(STORAGE_KEYS.SELECTED_COMPANY);
                localStorage.removeItem(STORAGE_KEYS.SELECTED_PERIOD);
                log('üß™ Simulaci√≥n: Claves eliminadas manualmente para prueba', 'remove');
            }
        }

        // Iniciar monitoreo autom√°ticamente al cargar la p√°gina
        window.onload = function() {
            log('üîç Monitor de localStorage iniciado', 'info');
            startMonitoring();
        };

        // Detener monitoreo al cerrar la p√°gina
        window.onbeforeunload = function() {
            stopMonitoring();
        };
    </script>
</body>
</html>