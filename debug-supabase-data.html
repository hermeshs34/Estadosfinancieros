<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Datos de Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .data-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
        }
        .success {
            color: #155724;
            background: #d4edda;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Datos de Supabase</h1>
        <p>Esta herramienta verifica si hay datos en Supabase y por qu√© no se est√°n cargando en la aplicaci√≥n.</p>
        
        <div class="section">
            <h3>üè¢ Empresa y Per√≠odo Seleccionados</h3>
            <button onclick="checkSelectedCompanyPeriod()">Verificar Selecci√≥n</button>
            <div id="selection-status"></div>
        </div>
        
        <div class="section">
            <h3>üìä Datos en Supabase</h3>
            <button onclick="checkSupabaseData()">Verificar Datos en Supabase</button>
            <div id="supabase-status"></div>
        </div>
        
        <div class="section">
            <h3>üîÑ Simulaci√≥n de Carga</h3>
            <button onclick="simulateDataLoad()">Simular loadDataFromSupabase</button>
            <button onclick="diagnoseAutoLoad()">üîç Diagnosticar Auto-Carga</button>
            <button onclick="clearLocalStorage()" style="background: #dc3545;">üóëÔ∏è Limpiar localStorage</button>
            <button onclick="reloadMainApp()" style="background: #17a2b8;">üîÑ Recargar App Principal</button>
            <div id="simulation-status"></div>
        </div>
        
        <div class="section">
            <h3>üìù Log de Debug</h3>
            <div id="debug-log"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            SELECTED_COMPANY: 'financial_app_selected_company',
            SELECTED_PERIOD: 'financial_app_selected_period',
            IMPORTED_DATA: 'financial_app_imported_data'
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `data-item ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.insertBefore(logEntry, logDiv.firstChild);
            console.log(`[DEBUG] ${message}`);
        }

        function checkSelectedCompanyPeriod() {
            const statusDiv = document.getElementById('selection-status');
            statusDiv.innerHTML = '';
            
            log('=== DIAGN√ìSTICO DE EMPRESA Y PER√çODO ===');
            
            // Mostrar informaci√≥n del dominio actual
            log(`Dominio actual: ${window.location.origin}`);
            log(`URL completa: ${window.location.href}`);
            
            // Mostrar todas las claves de localStorage
            log('Todas las claves en localStorage:');
            if (localStorage.length === 0) {
                log('  ‚ö†Ô∏è localStorage est√° completamente vac√≠o');
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    log(`  "${key}": ${value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : 'null'}`);
                }
            }
            
            // Buscar claves que contengan 'company' o 'period'
            log('\nClaves relacionadas con empresa/per√≠odo:');
            const allKeys = Object.keys(localStorage);
            const relatedKeys = allKeys.filter(key => 
                key.toLowerCase().includes('company') || 
                key.toLowerCase().includes('period') ||
                key.toLowerCase().includes('empresa') ||
                key.toLowerCase().includes('periodo')
            );
            
            if (relatedKeys.length === 0) {
                log('  ‚ùå No se encontraron claves relacionadas');
            } else {
                relatedKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    log(`  "${key}": ${value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : 'null'}`);
                });
            }
            
            const companyData = localStorage.getItem(STORAGE_KEYS.SELECTED_COMPANY);
            const periodData = localStorage.getItem(STORAGE_KEYS.SELECTED_PERIOD);
            
            log(`\nBuscando clave empresa exacta: '${STORAGE_KEYS.SELECTED_COMPANY}'`);
            log(`Valor encontrado: ${companyData ? 'S√ç ENCONTRADO' : 'NO ENCONTRADO'}`);
            if (companyData) {
                log(`Contenido completo: ${companyData}`);
            }
            
            log(`\nBuscando clave per√≠odo exacta: '${STORAGE_KEYS.SELECTED_PERIOD}'`);
            log(`Valor encontrado: ${periodData ? 'S√ç ENCONTRADO' : 'NO ENCONTRADO'}`);
            if (periodData) {
                log(`Contenido completo: ${periodData}`);
            }
            
            let company = null;
            let period = null;
            
            if (companyData) {
                try {
                    company = JSON.parse(companyData);
                    const div = document.createElement('div');
                    div.className = 'data-item success';
                    div.innerHTML = `‚úÖ Empresa: ${company.name} (ID: ${company.id})`;
                    statusDiv.appendChild(div);
                    log(`‚úÖ Empresa seleccionada: ${company.name}`);
                } catch (e) {
                    const div = document.createElement('div');
                    div.className = 'data-item error';
                    div.innerHTML = `‚ùå Error parsing empresa: ${e.message}`;
                    statusDiv.appendChild(div);
                    log(`‚ùå Error parsing empresa: ${e.message}`);
                }
            } else {
                const div = document.createElement('div');
                div.className = 'data-item error';
                div.innerHTML = `‚ùå No hay empresa seleccionada<br><small>Total claves en localStorage: ${localStorage.length}<br>Claves relacionadas: ${relatedKeys.length}<br>Dominio: ${window.location.origin}</small>`;
                statusDiv.appendChild(div);
                log('‚ùå No hay empresa seleccionada');
            }
            
            if (periodData) {
                try {
                    period = JSON.parse(periodData);
                    const div = document.createElement('div');
                    div.className = 'data-item success';
                    div.innerHTML = `‚úÖ Per√≠odo: ${period.period_name || period.name} (ID: ${period.id})`;
                    statusDiv.appendChild(div);
                    log(`‚úÖ Per√≠odo seleccionado: ${period.period_name || period.name}`);
                } catch (e) {
                    const div = document.createElement('div');
                    div.className = 'data-item error';
                    div.innerHTML = `‚ùå Error parsing per√≠odo: ${e.message}`;
                    statusDiv.appendChild(div);
                    log(`‚ùå Error parsing per√≠odo: ${e.message}`);
                }
            } else {
                const div = document.createElement('div');
                div.className = 'data-item error';
                div.innerHTML = `‚ùå No hay per√≠odo seleccionado<br><small>Total claves en localStorage: ${localStorage.length}<br>Claves relacionadas: ${relatedKeys.length}<br>Dominio: ${window.location.origin}</small>`;
                statusDiv.appendChild(div);
                log('‚ùå No hay per√≠odo seleccionado');
            }
            
            // Mostrar si se pueden cargar datos
            if (company && period) {
                const div = document.createElement('div');
                div.className = 'data-item success';
                div.innerHTML = `‚úÖ Condiciones cumplidas para cargar desde Supabase`;
                statusDiv.appendChild(div);
                log('‚úÖ Condiciones cumplidas para cargar desde Supabase');
            } else {
                const div = document.createElement('div');
                div.className = 'data-item warning';
                div.innerHTML = `‚ö†Ô∏è Faltan condiciones para cargar desde Supabase<br><small>Diagn√≥stico completo disponible en el log de debug</small>`;
                statusDiv.appendChild(div);
                log('‚ö†Ô∏è Faltan condiciones para cargar desde Supabase');
            }
        }

        function checkSupabaseData() {
            const statusDiv = document.getElementById('supabase-status');
            statusDiv.innerHTML = '';
            
            log('üìä Verificando datos en Supabase...');
            
            const div = document.createElement('div');
            div.className = 'data-item warning';
            div.innerHTML = `‚ö†Ô∏è Esta funci√≥n requiere acceso directo a Supabase. <br>
                           Para verificar datos reales, revisa la consola del navegador en la aplicaci√≥n principal <br>
                           y busca logs de "loadDataFromSupabase" o "getFinancialEntries".`;
            statusDiv.appendChild(div);
            
            log('‚ö†Ô∏è Verificaci√≥n de Supabase requiere acceso desde la aplicaci√≥n principal');
        }

        async function simulateDataLoad() {
            const statusDiv = document.getElementById('simulation-status');
            statusDiv.innerHTML = '';
            
            log('üîÑ Simulando carga de datos...');
            
            const companyData = localStorage.getItem(STORAGE_KEYS.SELECTED_COMPANY);
            const periodData = localStorage.getItem(STORAGE_KEYS.SELECTED_PERIOD);
            
            if (!companyData || !periodData) {
                const div = document.createElement('div');
                div.className = 'data-item error';
                div.innerHTML = `‚ùå No se puede simular: falta empresa o per√≠odo seleccionado`;
                statusDiv.appendChild(div);
                log('‚ùå Simulaci√≥n cancelada: falta empresa o per√≠odo');
                return;
            }
            
            try {
                const company = JSON.parse(companyData);
                const period = JSON.parse(periodData);
                
                const div = document.createElement('div');
                div.className = 'data-item success';
                div.innerHTML = `‚úÖ Simulaci√≥n: loadDataFromSupabase('${company.id}', '${period.id}')`;
                statusDiv.appendChild(div);
                
                log(`üìä Simulando carga para: ${company.name} - ${period.period_name || period.name}`);
                
                // Forzar la carga en la aplicaci√≥n principal
                try {
                    // Enviar mensaje a la ventana principal para forzar la carga
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'FORCE_SUPABASE_LOAD',
                            company: company,
                            period: period
                        }, '*');
                        log('üì§ Mensaje enviado a la aplicaci√≥n principal para forzar carga');
                    } else {
                        log('‚ö†Ô∏è No se puede comunicar con la aplicaci√≥n principal');
                    }
                    
                    // Tambi√©n intentar acceder directamente al DataContext si est√° disponible
                    log('üîç Intentando acceder al DataContext...');
                    
                    // Simular delay de red
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    log('‚úÖ Simulaci√≥n completada. Revisa la consola de la aplicaci√≥n principal.');
                } catch (error) {
                    log('‚ùå Error en la simulaci√≥n: ' + error.message);
                }
                
                // Mostrar qu√© deber√≠a pasar
                const steps = [
                    '1. Llamar a SupabaseService.getFinancialEntries()',
                    '2. Mapear datos de Supabase al formato interno',
                    '3. Ejecutar setImportedData() con los datos mapeados',
                    '4. Actualizar availableDates',
                    '5. Procesar an√°lisis financiero'
                ];
                
                steps.forEach(step => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'data-item';
                    stepDiv.innerHTML = step;
                    statusDiv.appendChild(stepDiv);
                });
                
                // Verificar si hay datos en localStorage despu√©s de la carga
                setTimeout(() => {
                    const importedData = localStorage.getItem(STORAGE_KEYS.IMPORTED_DATA);
                    if (importedData) {
                        try {
                            const parsed = JSON.parse(importedData);
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'data-item success';
                            resultDiv.innerHTML = `üìä Datos encontrados en localStorage: ${parsed.length} registros`;
                            statusDiv.appendChild(resultDiv);
                            log(`üìä Datos en localStorage: ${parsed.length} registros`);
                        } catch (e) {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'data-item error';
                            resultDiv.innerHTML = `‚ùå Error parsing datos: ${e.message}`;
                            statusDiv.appendChild(resultDiv);
                            log(`‚ùå Error parsing datos: ${e.message}`);
                        }
                    } else {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'data-item warning';
                        resultDiv.innerHTML = `‚ö†Ô∏è No se encontraron datos en localStorage despu√©s de la simulaci√≥n`;
                        statusDiv.appendChild(resultDiv);
                        log('‚ö†Ô∏è No hay datos en localStorage');
                    }
                }, 2000);
                
            } catch (e) {
                const div = document.createElement('div');
                div.className = 'data-item error';
                div.innerHTML = `‚ùå Error en simulaci√≥n: ${e.message}`;
                statusDiv.appendChild(div);
                log(`‚ùå Error en simulaci√≥n: ${e.message}`);
            }
        }

        function diagnoseAutoLoad() {
             log('üîç === DIAGN√ìSTICO DE AUTO-CARGA ===');
             
             // Verificar empresa y per√≠odo seleccionados
             const companyData = localStorage.getItem(STORAGE_KEYS.SELECTED_COMPANY);
             const periodData = localStorage.getItem(STORAGE_KEYS.SELECTED_PERIOD);
             
             let company = null;
             let period = null;
             
             if (companyData) {
                 try {
                     company = JSON.parse(companyData);
                 } catch (e) {
                     log('‚ùå Error parsing empresa: ' + e.message);
                 }
             }
             
             if (periodData) {
                 try {
                     period = JSON.parse(periodData);
                 } catch (e) {
                     log('‚ùå Error parsing per√≠odo: ' + e.message);
                 }
             }
             
             log('üìä Estado actual:');
             log(`- Empresa seleccionada: ${company ? company.name : 'NO'}`);
             log(`- Per√≠odo seleccionado: ${period ? (period.period_name || period.name) : 'NO'}`);
             
             if (!company || !period) {
                 log('‚ùå PROBLEMA: Falta empresa o per√≠odo seleccionado');
                 log('üí° SOLUCI√ìN: Selecciona empresa y per√≠odo en la aplicaci√≥n principal');
                 return;
             }
             
             // Verificar localStorage
             log('üíæ Verificando localStorage...');
             log(`- Empresa en localStorage: ${companyData ? 'S√ç' : 'NO'}`);
             log(`- Per√≠odo en localStorage: ${periodData ? 'S√ç' : 'NO'}`);
             
             // Verificar datos importados
             const importedData = localStorage.getItem(STORAGE_KEYS.IMPORTED_DATA);
             if (importedData) {
                 try {
                     const data = JSON.parse(importedData);
                     log(`üìã Datos importados: ${data.length} registros`);
                 } catch (e) {
                     log('‚ùå Error al parsear datos importados');
                 }
             } else {
                 log('üìã No hay datos importados en localStorage');
             }
             
             // Verificar condiciones del useEffect
             log('üîÑ Condiciones para auto-carga:');
             log('‚úÖ selectedCompany?.id: ' + (company ? 'S√ç' : 'NO'));
             log('‚úÖ selectedPeriod?.id: ' + (period ? 'S√ç' : 'NO'));
             log('‚ö†Ô∏è !preventAutoReload: DESCONOCIDO (solo visible en la aplicaci√≥n)');
             
             if (company && period) {
                 log('‚úÖ Todas las condiciones b√°sicas se cumplen');
                 log('üîÑ El useEffect deber√≠a ejecutarse autom√°ticamente');
                 log('üí° Si no se ejecuta, puede ser por preventAutoReload=true');
                 
                 // Enviar mensaje para forzar diagn√≥stico en la aplicaci√≥n principal
                 if (window.opener) {
                     window.opener.postMessage({
                         type: 'DIAGNOSE_AUTO_LOAD',
                         company: company,
                         period: period
                     }, '*');
                     log('üì§ Mensaje de diagn√≥stico enviado a la aplicaci√≥n principal');
                 }
             } else {
                 log('‚ùå Faltan condiciones b√°sicas para la auto-carga');
             }
         }

         function clearLocalStorage() {
             if (confirm('¬øEst√°s seguro de que quieres limpiar todo el localStorage? Esto eliminar√° todas las selecciones y datos guardados.')) {
                 localStorage.clear();
                 log('üóëÔ∏è localStorage limpiado completamente');
                 log('üîÑ Recarga la aplicaci√≥n principal para empezar de nuevo');
                 
                 // Actualizar la visualizaci√≥n
                 checkSelectedCompanyPeriod();
             }
         }

         function reloadMainApp() {
             if (window.opener) {
                 log('üîÑ Enviando mensaje para recargar la aplicaci√≥n principal...');
                 window.opener.postMessage({
                     type: 'RELOAD_APP'
                 }, '*');
                 log('üì§ Mensaje de recarga enviado');
             } else {
                 log('‚ö†Ô∏è No se puede comunicar con la aplicaci√≥n principal');
                 log('üí° Intenta recargar manualmente la pesta√±a de la aplicaci√≥n');
             }
         }

        // Auto-ejecutar verificaci√≥n inicial
        window.onload = function() {
            log('üöÄ Herramienta de debug iniciada');
            checkSelectedCompanyPeriod();
        };
    </script>
</body>
</html>